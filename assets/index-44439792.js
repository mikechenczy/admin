var _=Object.defineProperty;var u=Object.getOwnPropertySymbols;var C=Object.prototype.hasOwnProperty,w=Object.prototype.propertyIsEnumerable;var f=(e,o,t)=>o in e?_(e,o,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[o]=t,p=(e,o)=>{for(var t in o||(o={}))C.call(o,t)&&f(e,t,o[t]);if(u)for(var t of u(o))w.call(o,t)&&f(e,t,o[t]);return e};var d=(e,o,t)=>new Promise((a,i)=>{var n=s=>{try{r(t.next(s))}catch(m){i(m)}},l=s=>{try{r(t.throw(s))}catch(m){i(m)}},r=s=>s.done?a(s.value):Promise.resolve(s.value).then(n,l);r((t=t.apply(e,o)).next())});import{d as defineComponent,J as toRaw,f as ref,Z as openBlock,a5 as createBlock,a6 as withCtx,$ as createBaseVNode,k as createVNode,u as unref,aa as mergeProps,aj as useRoute,r as reactive,y as nextTick,S as useRouter,a7 as resolveComponent,a9 as createCommentVNode,a1 as normalizeClass,_ as createElementBlock,F as Fragment,a8 as renderList,G as createTextVNode,a0 as toDisplayString,m as withDirectives,A as vShow}from"./vue-ae6a2213.js";import{Y as useGlobSetting,aq as getEntity,ar as getTableData,as as updateData,at as saveData,au as useMessage,av as runJavaCmd,aw as querystring,ax as getToken,ay as deleteData}from"./index.js";import{a as useTable,g as getAnnoSearchForm,d as getAnnoAddForm,e as getAnnoEditForm,f as getAnnoDescriptionForm,h as getColumns,c as _sfc_main$3,b as _sfc_main$4,i as _sfc_main$7}from"./componentMap-78462e6d.js";import{P as PageWrapper}from"./index-3b76004b.js";import{_ as _sfc_main$2}from"./AnnoTableTree.vue_vue_type_script_setup_true_lang-e324c97c.js";import{a as useModalInner,B as BasicModal,u as useModal}from"./index-470a7b7c.js";import{_ as _sfc_main$5,a as _sfc_main$6}from"./AnnoModal.vue_vue_type_script_setup_true_lang-c8c4333f.js";import{D as Description}from"./index-30867b68.js";import"./antd-8e9c6fb8.js";import"./useFormItem-e445be9f.js";import"./RadioButtonGroup.vue_vue_type_script_setup_true_lang-e84e3d3d.js";import"./useSortable-1cd8f8b5.js";import"./index-949a3570.js";import"./onMountedOrActivated-d6e0a436.js";import"./index-81505b2a.js";import"./copyTextToClipboard-6d09c6e8.js";import"./index-58c143a0.js";import"./index-ca06cd68.js";import"./useWindowSizeFn-be729167.js";import"./sortable.esm-9a942543.js";import"./useContentViewHeight-ca8eb444.js";const _hoisted_1={class:"h-screen"},_sfc_main$1=defineComponent({__name:"index",setup(e){const[o,{setModalProps:t,closeModal:a}]=useModalInner(c=>d(this,null,function*(){l.value=toRaw(c.modalTitle),r.value=toRaw(c.modalMinHeight),s.value=toRaw(c.modalHeight),m.value=toRaw(c.modalWidth),i.value=toRaw(c.rowData),n.value=toRaw(c.descriptionSchemaParam),t({confirmLoading:!1,title:l,width:m,minHeight:s,height:s,showOkBtn:!1,cancelText:"关闭"})})),i=ref({name:"测试",age:12,address:"test"}),n=ref([{label:"姓名",field:"name"},{label:"年龄",field:"age"},{label:"地址",field:"address"}]),l=ref("Iframe Modal"),r=ref("500px"),s=ref("500px"),m=ref("800px");function g(){}function h(){return d(this,null,function*(){t({confirmLoading:!1}),a()})}return(c,b)=>(openBlock(),createBlock(unref(BasicModal),mergeProps(c.$attrs,{onRegister:unref(o),title:"测试",onOk:h,onCancel:g}),{default:withCtx(()=>[createBaseVNode("div",_hoisted_1,[createVNode(unref(Description),{column:3,data:i.value,schema:n.value},null,8,["data","schema"])])]),_:1},16,["onRegister"]))}}),cache=new Map;function useComputed(e){function o(){cache.size>500&&cache.clear()}return function(...t){let a=JSON.stringify(t);return o(),cache.get(a)||cache.set(a,e(...t)).get(a)}}const _sfc_main=defineComponent({__name:"index",setup(__props){const{createMessage}=useMessage(),route=useRoute(),clazz=route.name,{apiUrl}=useGlobSetting(),config=reactive({enableLeftTree:!1}),[registerModal,{openModal}]=useModal(),[registerM2mModal,{openModal:openM2modal}]=useModal(),[registerIFrameModal,{openModal:openIFrameModal}]=useModal(),[registerDescriptionModal,{openModal:openDescriptionModal}]=useModal(),searchInfo=reactive({}),[registerTable,{reload,setProps,getForm}]=useTable({}),AnnoFormSchema=reactive({addScheme:[],editScheme:[]}),descriptionSchema=ref([]);let getActions=e=>[],getMoreActions=e=>[];getEntity(clazz).then(e=>{const o=getTableData(e.entityName,e.treeParentKey,e.treeKey,e.treeDisplayAsTree),t=getAnnoSearchForm(e.fields);AnnoFormSchema.addScheme=getAnnoAddForm(e.fields),AnnoFormSchema.editScheme=getAnnoEditForm(e.fields),descriptionSchema.value=getAnnoDescriptionForm(e.fields);let i=5-((AnnoFormSchema.editScheme.length>0?1:0)+(e.canRemove?1:0)+1);getActions=useComputed(n=>{let l=e.columnButtons.slice(0,i).map(r=>({icon:r.icon,tooltip:r.name,onClick:columnBtnClick.bind(null,{props:n,option:r})}));return[{icon:"clarity:info-standard-line",tooltip:"查看详情",onClick:handleView.bind(null,n)},{icon:"clarity:note-edit-line",tooltip:"编辑资料",onClick:handleEdit.bind(null,n),ifShow:r=>AnnoFormSchema.editScheme.length>0},{icon:"ant-design:delete-outlined",color:"error",tooltip:"删除此项",popConfirm:{title:"是否确认删除",placement:"left",confirm:handleDelete.bind(null,n)},ifShow:r=>e.canRemove},...l]}),getMoreActions=useComputed(n=>e.columnButtons.length<i?[]:e.columnButtons.slice(i).map(l=>({label:l.name,tooltip:l.name,onClick:columnBtnClick.bind(null,{props:n,option:l})}))),Object.assign(config,e),setProps({pagination:{pageSize:10},title:config.title,api:o,rowSelection:{},maxHeight:99999,canResize:!1,rowKey:e.pkField.fieldName,columns:getColumns(e.fields),indexColumnProps:{fixed:"left",width:50},formConfig:{rowProps:{gutter:16,justify:"start"},labelWidth:100,labelAlign:"left",schemas:t,autoSubmitOnEnter:!0,autoAdvancedLine:50,showAdvancedButton:!1,showSubmitButton:(t||[]).filter(n=>n.show({model:{}})).length>0,showResetButton:(t||[]).filter(n=>n.show({model:{}})).length>0},useSearchForm:t.length>0,showTableSetting:!0,bordered:!0,beforeFetch(n){return(!n.anOrderList||n.anOrderList.length===0)&&(n.anOrderList=e.anOrder),n},actionColumn:{width:(t.length>0?130:100)+(e.columnButtons.length>0?60:0),title:"操作",dataIndex:"action"}}),nextTick(()=>{const n=getForm();n.setFieldsValue(route.query),n.submit()})});function handleCreate(){openModal(!0,{isUpdate:!1})}const router=useRouter();function columnBtnClick({props,option}){if(option.javaCmdEnable){let javaCmdData=option.javaCmdData;runJavaCmd(clazz,p({annoJavaCmdId:javaCmdData.id},props)).then(res=>{let data=res.trimStart();data?data.startsWith("js://")?eval(data.substring(5)):createMessage.success(data):createMessage.success("操作成功"),reload()})}if(option.jumpUrl){option.jumpUrl=option.jumpUrl.replace("${props}",JSON.stringify(props)),window.open(option.jumpUrl);return}if(option.jsCmd){eval(option.jsCmd);return}if(option.m2mEnable&&openM2modal(!0,{props,option,isAdd:!1}),option.o2mEnable){const e={};e[option.o2mTargetJavaField]=props[option.o2mThisJavaField],router.push({name:option.o2mTargetClass,query:e})}option.tplEnable&&openIFrameModal(!0,{modalTitle:option.name,modalWidth:option.tplWindowWidth,modalHeight:option.tplWindowHeight,iframeSrc:`${apiUrl}/anno-admin-api/annoTpl?_tplId=${option.tplId}&${querystring.stringify(props)}&_tokenValue=${getToken()}`})}function handleEdit(e){openModal(!0,{record:e,isUpdate:!0})}function handleDelete(e){const o={};o[config.pkField.fieldName]=e[config.pkField.fieldName],deleteData(config.clazz,o).then(t=>{reload()})}function handleSuccess(a){return d(this,arguments,function*({isUpdate:e,values:o,closeModal:t}){if(e){if((config.enableTree||config.treeDisplayAsTree)&&o[config.treeKey]==o[config.treeParentKey]){createMessage.error("不能选择自己为自己的子节点");return}yield updateData(config.clazz,o).then(i=>{reload(),t(),createMessage.success("更新成功")})}else yield saveData(config.clazz,o).then(i=>{reload(),t(),createMessage.success("保存成功")})})}function handleSelect(e=""){searchInfo[config.leftTreeCatKey||config.treeKey||"__"]=e,getForm().setFieldsValue(searchInfo),getForm().submit()}function handleView(e){openDescriptionModal(!0,{modalTitle:"详情",modalWidth:900,modalHeight:500,rowData:e,descriptionSchemaParam:descriptionSchema})}const handleTableClick=item=>{if(item.jumpUrl){window.open(item.jumpUrl);return}if(item.jsCmd){eval(item.jsCmd);return}};return(e,o)=>{const t=resolveComponent("a-button");return openBlock(),createBlock(unref(PageWrapper),{dense:"",contentClass:"flex px-16px pt-16px",class:"min-h-full"},{default:withCtx(()=>[config.enableLeftTree||config.treeDisplayAsTree?(openBlock(),createBlock(_sfc_main$2,{key:0,"left-tree-name":config.enableLeftTree?config.leftTreeName:config.title,"left-tree-cat-key":config.enableLeftTree?config.leftTreeCatKey:config.treeKey,"left-tree-class":config.enableLeftTree?config.leftTreeClass:config.entityName,class:"w-1/4 xl:w-1/5 b-r-1 b-r-#eee",onSelect:handleSelect},null,8,["left-tree-name","left-tree-cat-key","left-tree-class"])):createCommentVNode("",!0),createVNode(unref(_sfc_main$3),{onRegister:unref(registerTable),class:normalizeClass(config.enableLeftTree||config.treeDisplayAsTree?"w-3/4 xl:w-4/5":"w-4/4 xl:w-5/5"),searchInfo},{toolbar:withCtx(()=>[(openBlock(!0),createElementBlock(Fragment,null,renderList(config.tableButtons,a=>(openBlock(),createBlock(t,{type:"primary",onClick:i=>handleTableClick(a)},{default:withCtx(()=>[createTextVNode(toDisplayString(a.name),1)]),_:2},1032,["onClick"]))),256)),withDirectives(createVNode(t,{type:"primary",onClick:handleCreate},{default:withCtx(()=>[createTextVNode("新增"+toDisplayString(config.title),1)]),_:1},512),[[vShow,(AnnoFormSchema.addScheme||[]).length>0]])]),bodyCell:withCtx(({column:a,record:i})=>[a.key==="action"?(openBlock(),createBlock(unref(_sfc_main$4),{key:0,divider:!1,actions:unref(getActions)(i),dropDownActions:unref(getMoreActions)(i,"more")},null,8,["actions","dropDownActions"])):createCommentVNode("",!0)]),_:1},8,["onRegister","class","searchInfo"]),createVNode(_sfc_main$5,{onRegister:unref(registerModal),"column-m2m-button":(config.columnButtons||[]).filter(a=>a.m2mEnable),"add-schema":AnnoFormSchema.addScheme||[],"edit-schema":AnnoFormSchema.editScheme||[],onSuccess:handleSuccess},null,8,["onRegister","column-m2m-button","add-schema","edit-schema"]),createVNode(_sfc_main$6,{onRegister:unref(registerM2mModal)},null,8,["onRegister"]),createVNode(_sfc_main$7,{onRegister:unref(registerIFrameModal)},null,8,["onRegister"]),createVNode(_sfc_main$1,{onRegister:unref(registerDescriptionModal)},null,8,["onRegister"])]),_:1})}}});export{_sfc_main as default};
